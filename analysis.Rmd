---
title: Coursera - Reproducible Research - Assignment 2
subtitle: TODO briefly summarizes your data analysis
author: Ron Ammar
output: 
  html_document:
    toc: true
    toc_depth: 4
---

```{r global_options, include=FALSE}
  # use include=FALSE to have the chunk evaluated, but neither the code nor its output displayed.
  knitr::opts_chunk$set(echo=TRUE, message=FALSE, fig.align="center",
                        fig.width=12, fig.height=8, fig.path='figure/',
                        dev='png')
```

```{r}
  # Clear the current session, to avoid errors from persisting data structures
  rm(list=ls())

  # Free up memory by forcing garbage collection
  invisible(gc())

  # Pretty printing in knitr
  library(printr)

  # Manually set the seed to an arbitrary number for consistency in reports
  set.seed(1234)

  # Do not convert character vectors to factors unless explicitly indicated
  options(stringsAsFactors=FALSE)

  startTime <- Sys.time()
  
  library(dplyr)
  library(ggplot2)
  library(stringr)
```

## Summary

***Synopsis that describes and summarizes the data analysis in less than 10 sentences?***

## Background

Storms and other severe weather events can cause both public health and economic problems for communities and municipalities. Many severe events can result in fatalities, injuries, and property damage, and preventing such outcomes to the extent possible is a key concern.

This project involves exploring the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

The events in the database start in the year 1950 and end in November 2011. In the earlier years of the database there are generally fewer events recorded, most likely due to a lack of good records. More recent years should be considered more complete.

## Purpose

The purpose of this analysis is to:

1. Complete the Reproducible Research course project #2.
2. Across the United States, determine which types of events are most harmful to population health?
3. Across the United States, which types of events have the greatest economic consequences?

## Data Processing

**Analysis Date:** `r format(Sys.time(), "%k:%M:%S, %A, %B %d, %Y")` 

***Describes how the data were loaded into R and processed for analysis?***

```{r, cache=TRUE}
  ##### This knitr chunk is cached to increase development speed.
  stormData <- read.csv(bzfile("data/repdata-data-StormData.csv.bz2"))
```

First, let's process the storm data dates and times into R POSIX time. We will also parse the damages.

```{r}
  # Add the time to the date and format as POSIX time
  stormData$BGN_DATE <- str_replace(stormData$BGN_DATE, "\\s.+", "")
  dates <- strptime(stormData$BGN_DATE, format="%m/%d/%Y")
  stormData$MONTH <- factor(months(dates), levels=month.name)
  
  # EXPLORATORY: figure out which symbols are used to define the cost magnitude
  # count(stormData, CROPDMGEXP)
  # count(stormData, PROPDMGEXP)
  
  # Compute the cost and multiple by correct factor/exponent
  expLookup <- list(h=2, H=2, k=3, K=3, m=6, M=6, B=9)
  
  computeDamages <- function(damage, damageExp) {
    # Precondition: damage and damageExp have the same length
    output <- vector(mode="numeric", length=length(damage))
    for (i in 1:length(damage)) {
      # Determine if damageExp is an allowed character or integer
      num <- as.numeric(damageExp[i])
      exponent <- 0  # if it doesn't fit into the categories, return the raw damages
      if (!is.na(num)) {
        exponent <- num
      } else if (damageExp[i] %in% names(expLookup)) {
        exponent <- expLookup[[damageExp[i]]]
      }
      
      output[i] <- damage[i] * 10 ^ exponent
    }
    
    return(output)
  }
  
  # Add to source table
  stormData <- mutate(stormData,
                      pDMG=computeDamages(PROPDMG, PROPDMGEXP),
                      cDMG=computeDamages(CROPDMG, CROPDMGEXP))
```

## Results

Let's take a look at how much destruction is attributed to storms in the US by month over the period of this survey.

```{r}
summary <- stormData %>%
  group_by(MONTH) %>%
  summarise(fatalities=sum(FATALITIES), injuries=sum(INJURIES), property_damage=sum(pDMG), crop_damage=sum(cDMG)) %>%
  mutate(property_damage=format(property_damage, scientific=TRUE, digits=2),
         crop_damage=format(crop_damage, scientific=TRUE, digits=2))
```

### Which types of events are most harmful to population health?

### Which types of events have the greatest economic consequences?

UP TO 3 FIGURES, WITH DESCRIPTIVE CAPTIONS

------

## System Information

***Time required to process this report:*** *`r format(Sys.time() - startTime)`*

***R session information:***

```{r, echo_session_info}
  sessionInfo()
```
